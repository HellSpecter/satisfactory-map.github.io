<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satisfactory Map Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            font-family: Arial, sans-serif;
            height: 100vh;
            background: #1a1a1a;
        }

        #viewer-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #map-wrapper {
            position: absolute;
            transform-origin: 0 0;
        }

        #map-image {
            display: block;
            width: 5112px;
            height: 5112px;
            user-select: none;
        }

        /* Счётчик неотмеченных объектов */
        #counter {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 8px 15px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 18px;
            font-weight: bold;
            border: 1px solid #444;
        }

        /* Стиль чекпоинтов */
        .checkpoint {
            position: absolute;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background-color: rgba(255, 50, 50, 0.8);
            border: 2px solid gold;
            cursor: pointer;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            z-index: 10;
            transition: transform 0.2s, background-color 0.3s;
            pointer-events: auto;
        }

        /* Выделенный чекпоинт (красный) */
        .checkpoint.checked {
            background-color: #ff3333; /* Ярко-красный при выборе */
        }

        .checkpoint:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 20;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            transform: translate(-50%, -100%);
            margin-top: -8px;
            border: 1px solid #444;
        }
    </style>
</head>
<body>
    <div id="counter">Неотмеченных: 0</div>
    <div id="viewer-container">
        <div id="map-wrapper">
            <img id="map-image" src="images/map.jpg" alt="Satisfactory Map">
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === Элементы ===
            const viewer = document.getElementById('viewer-container');
            const mapWrapper = document.getElementById('map-wrapper');
            const mapImage = document.getElementById('map-image');
            const counterEl = document.getElementById('counter');

            // === Параметры изображения ===
            const IMG_WIDTH = 5112;
            const IMG_HEIGHT = 5112;

            // === Состояние просмотрщика ===
            let scale = 1;
            let offsetX = 0;
            let offsetY = 0;
            let isDragging = false;
            let startDragX = 0;
            let startDragY = 0;
            let lastX = 0;
            let lastY = 0;

            // === Данные чекпоинтов ===
            let checkpoints = [];       // Все чекпоинты из coords.json
            let checkedState = {};      // Состояние (checked/unchecked)
            let totalCheckpoints = 0;    // Общее количество

            // === Загрузка данных из JSON ===
            async function loadData() {
                try {
                    // Загрузка координат чекпоинтов (coords.json)
                    const coordsResponse = await fetch('coords.json');
                    const coordsData = await coordsResponse.json();
                    checkpoints = coordsData.checkpoints || [];

                    // Загрузка состояния из data.json (или localStorage)
                    let savedState = {};
                    try {
                        const dataResponse = await fetch('data.json');
                        const dataJson = await dataResponse.json();
                        savedState = dataJson.checked || {};
                    } catch (e) {
                        console.warn('data.json не найден, используется localStorage');
                    }

                    // Если в localStorage есть данные — используем их
                    const localState = localStorage.getItem('satisfactoryCheckedState');
                    if (localState) {
                        savedState = JSON.parse(localState);
                    }

                    checkedState = savedState;
                    totalCheckpoints = checkpoints.length;
                    renderCheckpoints();
                    updateCounter();
                } catch (error) {
                    console.error('Ошибка загрузки данных:', error);
                }
            }

            // === Отрисовка чекпоинтов ===
            function renderCheckpoints() {
                // Удаляем старые элементы
                document.querySelectorAll('.checkpoint, .tooltip').forEach(el => el.remove());

                checkpoints.forEach((cp, index) => {
                    const isChecked = checkedState[cp.id] || false;

                    // Чекпоинт
                    const checkpoint = document.createElement('div');
                    checkpoint.className = `checkpoint ${isChecked ? 'checked' : ''}`;
                    checkpoint.dataset.id = cp.id;
                    checkpoint.dataset.x = cp.x;
                    checkpoint.dataset.y = cp.y;
                    checkpoint.style.left = `${cp.x}px`;
                    checkpoint.style.top = `${cp.y}px`;
                    checkpoint.innerHTML = `<div>${index + 1}</div>`;
                    mapWrapper.appendChild(checkpoint);

                    // Тултип
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.id = `tooltip-${cp.id}`;
                    tooltip.textContent = cp.tooltip || 'Описание отсутствует';
                    document.getElementById('viewer-container').appendChild(tooltip);

                    // Обработчики событий
                    checkpoint.addEventListener('click', (e) => {
                        e.stopPropagation(); // Не мешает перетаскиванию карты
                        toggleCheckpoint(cp.id);
                    });

                    checkpoint.addEventListener('mouseenter', () => {
                        tooltip.style.opacity = '1';
                        positionTooltip(cp.id);
                    });

                    checkpoint.addEventListener('mouseleave', () => {
                        tooltip.style.opacity = '0';
                    });
                });
            }

            // === Переключение состояния чекпоинта ===
            function toggleCheckpoint(id) {
                checkedState[id] = !checkedState[id];
                
                // Сохраняем в localStorage (в браузере нельзя писать в data.json)
                localStorage.setItem('satisfactoryCheckedState', JSON.stringify(checkedState));
                
                // Обновляем UI
                const checkpoint = document.querySelector(`.checkpoint[data-id="${id}"]`);
                checkpoint.classList.toggle('checked', checkedState[id]);
                updateCounter();
            }

            // === Позиционирование тултипа ===
            function positionTooltip(id) {
                const checkpoint = document.querySelector(`.checkpoint[data-id="${id}"]`);
                const tooltip = document.getElementById(`tooltip-${id}`);
                if (!checkpoint || !tooltip) return;

                const rect = checkpoint.getBoundingClientRect();
                const viewerRect = viewer.getBoundingClientRect();

                tooltip.style.left = `${rect.left}px`;
                tooltip.style.top = `${rect.top - 40}px`;
            }

            // === Обновление счётчика ===
            function updateCounter() {
                const checkedCount = Object.values(checkedState).filter(v => v).length;
                const unchecked = totalCheckpoints - checkedCount;
                counterEl.textContent = `Неотмеченных: ${unchecked}`;
            }

            // === Обновление трансформации ===
            function updateTransform() {
                mapWrapper.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
            }

            // === Масштабирование колёсиком мыши ===
            viewer.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newScale = scale + delta;

                if (newScale < 0.3 || newScale > 5) return;

                const rect = viewer.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                const oldScale = scale;
                scale = newScale;

                offsetX -= (mouseX - offsetX) * (scale / oldScale - 1);
                offsetY -= (mouseY - offsetY) * (scale / oldScale - 1);

                updateTransform();
            });

            // === Перетаскивание карты ===
            viewer.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return; // Только ЛКМ
                isDragging = true;
                startDragX = e.clientX;
                startDragY = e.clientY;
                lastX = offsetX;
                lastY = offsetY;
                viewer.style.cursor = 'grabbing';
            });

            // Отпускание ЛКМ — ОСТАНАВЛИВАЕТ перетаскивание
            document.addEventListener('mouseup', () => {
                isDragging = false;
                viewer.style.cursor = 'grab';
            });

            viewer.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startDragX;
                const dy = e.clientY - startDragY;
                offsetX = lastX + dx;
                offsetY = lastY + dy;
                updateTransform();
            });

            // === Инициализация ===
            loadData();
            updateTransform();

            // === Адаптивность ===
            window.addEventListener('resize', () => {
                updateTransform();
            });
        });
    </script>
</body>
</html>
